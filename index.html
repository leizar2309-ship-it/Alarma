<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarma Cloud con Notificaci√≥n</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; z-index: 1; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        .item { background: #fff; margin-top: 10px; padding: 15px; border-radius: 12px; width: 100%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-delete { background: #ff4757; width: auto; padding: 5px 10px; }

        /* --- VENTANA DE NOTIFICACI√ìN (MODAL) --- */
        #modalAlarma {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            width: 80%;
            max-width: 350px;
            animation: bounceIn 0.5s;
        }
        .modal-content h1 { color: #ff4757; font-size: 2rem; margin-bottom: 10px; }
        .modal-content p { font-size: 1.2rem; color: #333; font-weight: bold; margin-bottom: 20px; }
        .btn-stop-modal { background: #ff4757; font-size: 1.2rem; padding: 15px; }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="card">
    <h2>‚è∞ Alarma Pro Cloud</h2>
    
    <div style="background: #e8f0fe; padding: 10px; border-radius: 10px;">
        <label style="font-size: 11px;">üéµ Sonido:</label>
        <input type="file" id="audioFile" accept="audio/*">
    </div>

    <input type="text" id="tarea" placeholder="¬øQu√© nombre tiene la alarma?">
    <input type="datetime-local" id="fecha">
    
    <button onclick="guardar()">üíæ GUARDAR ALARMA</button>
</div>

<div id="modalAlarma">
    <div class="modal-content">
        <h1>‚è∞ ¬°ALERTA!</h1>
        <p id="nombreAlarmaTxt">Nombre de la tarea</p>
        <button class="btn-stop-modal" onclick="detenerAlarma()">DETENER SONIDO</button>
    </div>
</div>

<div id="lista" style="width: 100%; max-width: 400px; margin-top: 20px;"></div>
<audio id="alarmaAudio" loop playsinline></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDhv7MyudfyxIUf2OXuy4Gnn8mdNFW_xIU",
        authDomain: "mialarmapro.firebaseapp.com",
        databaseURL: "https://mialarmapro-default-rtdb.firebaseio.com", 
        projectId: "mialarmapro",
        storageBucket: "mialarmapro.firebasestorage.app",
        messagingSenderId: "978466433092",
        appId: "1:978466433092:web:11903d2bf289294a7c3411"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const audioPlayer = document.getElementById('alarmaAudio');
    const modal = document.getElementById('modalAlarma');
    const nombreTxt = document.getElementById('nombreAlarmaTxt');

    // Desbloquear audio al primer toque
    document.body.addEventListener('click', () => {
        audioPlayer.play().then(() => { audioPlayer.pause(); audioPlayer.currentTime = 0; });
    }, { once: true });

    document.getElementById('audioFile').onchange = (e) => {
        if (e.target.files[0]) audioPlayer.src = URL.createObjectURL(e.target.files[0]);
    };

    function detenerAlarma() {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        modal.style.display = "none"; // Ocultar ventana
    }

    function guardar() {
        const t = document.getElementById('tarea').value;
        const f = document.getElementById('fecha').value;
        if(!t || !f) return alert("Completa los datos");

        db.ref('alarmas').push({
            texto: t,
            tiempo: new Date(f).getTime(),
            avisado: false
        }).then(() => {
            alert("‚úÖ Guardada en la nube");
            document.getElementById('tarea').value = "";
        });
    }

    db.ref('alarmas').on('value', (snapshot) => {
        const listaDiv = document.getElementById('lista');
        listaDiv.innerHTML = "<h3>Pr√≥ximas Alarmas:</h3>";
        const datos = snapshot.val();
        const ahora = Date.now();

        if (datos) {
            for (let id in datos) {
                const r = datos[id];
                listaDiv.innerHTML += `
                    <div class="item">
                        <div><strong>${r.texto}</strong><br><small>${new Date(r.tiempo).toLocaleString()}</small></div>
                        <button class="btn-delete" onclick="eliminar('${id}')">üóëÔ∏è</button>
                    </div>
                `;
                if (ahora >= r.tiempo && !r.avisado) {
                    dispararAlarma(id, r.texto);
                }
            }
        }
    });

    function dispararAlarma(id, texto) {
        db.ref('alarmas/' + id).update({ avisado: true });
        
        // Configurar y mostrar ventana
        nombreTxt.innerText = texto;
        modal.style.display = "flex";
        
        audioPlayer.play().catch(() => alert("‚è∞ ¬°HORA DE: " + texto + "!"));
        
        if (Notification.permission === 'granted') {
            new Notification("‚è∞ " + texto, { body: "Es hora de cumplir tu tarea", requireInteraction: true });
        }
    }

    function eliminar(id) {
        if(confirm("¬øBorrar alarma?")) db.ref('alarmas/' + id).remove();
    }

    Notification.requestPermission();
</script>
</body>
</html>
